---
title: "Segmentation"
author: "Silvia Ventoruzzo"
date: "18/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Explanation of dataset:
- aisles and departments contain the respective id and name
- products contain the id, name and corresponsing aisle and department
- orders has one line pro order with the corresponding time, evaluation set and customer. "order_number" indicates the order for each customer in which the orders were placed
- order_products_(prior and train) contain more detailed information of the order, that is the products ordered, in which order they were put into the basket and if the corresponding customer already ordered that specific product 

```{r}
orders_prior <- orders %>%
  full_join(order_products_prior, by = "order_id") %>%
  arrange(user_id, order_number)
```

All 1st orders have NA for "days_since_prior_order" and 0 for all products in "reordered"
```{r}
orders_prior %>%
  filter(order_number == 1) %>%
  group_by(days_since_prior_order) %>%
  summarize(count = n())

orders_prior %>%
  filter(order_number == 1) %>%
  group_by(reordered) %>%
  summarize(count = n())
```

To which evaluation set do the orders for the different users belong?
```{r}
orders %>%
  group_by(user_id, eval_set) %>%
  summarize(count = n())
```

There is one department/aisle combination where both have value "missing". Since there is also one combination with "other", I will set this missing values so to say to the "other" category
```{r}
departments %>% filter(department == "missing" | department == "other")
# 2: other
# 21: missing

aisles %>% filter(aisle == "missing" | aisle == "other")
# 6: other
# 100: missing

# products
products <- products %>%
  left_join(aisles, by = "aisle_id") %>%
  left_join(departments, by = "department_id") %>%
  mutate(department_id = replace(department_id, department == "missing", 2),
         department = replace(department, department == "missing", "other"),
         aisle_id = replace(aisle_id, aisle == "missing", 6),
         aisle = replace(aisle, aisle == "missing", "other")) %>%
    droplevels()

# departments
departments <- departments %>%
  mutate(department_id = replace(department_id, department == "missing", 2),
         department = fct_recode(department, "other" = "missing")) %>%
  distinct(department_id, department)
         
# aisles
aisles <- aisles %>%
  mutate(aisle_id = replace(aisle_id, aisle == "missing", 6),
         aisle = fct_recode(aisle, "other" = "missing")) %>%
  distinct(aisle_id, aisle)

```

Each aisles is assigned to one specific department
```{r}
products %>%
  group_by(aisle_id) %>%
  summarize(count_department_id = n_distinct(department_id)) %>%
  summarize(aisle_department = sum(count_department_id))

aisles_departments <- products %>%
  distinct(department_id, aisle_id) %>%
  left_join(aisles, by = "aisle_id") %>%
  left_join(departments, by = "department_id") %>%
  arrange(department_id) 
```

Treemap aisles/department
```{r}
library(treemap)
products %>%
  group_by(department, aisle) %>%
  summarize(count = n()) %>%
  treemap(dtf = .,
          index = c("department", "aisle"),
          vSize = "count",
          type = "index",
          palette = "Spectral",
          title = "Products per department and aisle")

products %>%
  group_by(department) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

products %>%
  group_by(aisle) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

```

What info can we get about customers?
- how many orders they did?
- how many orders per day?
- how often they ordered?
- how many products pro order?

MAYBE I SHOULD DO ALL OF THIS ONLY ON PRIOR SET FOR TRAIN USERS
```{r}
# Keep only customers where we have complete information about orders (prior + train)
train_users <- orders %>%
  filter(eval_set == "train") %>% 
  distinct(user_id) %>%
  pull()
orders_train_users <- orders %>%
  filter(user_id %in% train_users) %>%
  distinct(order_id) %>%
  pull()
orders_no_test <- orders %>%
  filter(user_id %in% train_users) %>%
  droplevels()
order_products_prior_no_test <- order_products_prior %>%
  filter(order_id %in% orders_train_users) %>%
  droplevels()

# How many orders they did?
user_count_orders <- orders_no_test %>%
  group_by(user_id) %>%
  summarize(tot_orders = n_distinct(order_id))

# How many orders per day?
user_orders_day <- orders_no_test %>%
  group_by(user_id, order_dow) %>%
  summarize(count = n()) %>%
  spread(order_dow, count) %>%
  replace(is.na(.), 0) %>%
  rename_at(vars(-user_id), function(x) tolower(paste0(x,"_orders")))

# How often they ordered?
user_avg_days_since_prior_order <- orders_no_test %>%
  filter(order_number != 1) %>%
  group_by(user_id) %>%
  summarize(avg_days_since_prior_order = round(sum(days_since_prior_order)/n(), 0))

# How many products per order?
user_avg_products_order <- order_products_prior_no_test %>%
  full_join(order_products_train, by = c("order_id", "product_id", "add_to_cart_order", "reordered")) %>%
  right_join(orders_no_test, by = "order_id") %>%
  group_by(user_id) %>%
  summarize(avg_products_order = round(n()/n_distinct(order_id), 0))

# Join dataframes
users <- user_count_orders %>%
  inner_join(user_orders_day, by = "user_id") %>%
  inner_join(user_avg_days_since_prior_order, by = "user_id") %>%
  inner_join(user_avg_products_order, by = "user_id")
rm(user_count_orders)
rm(user_orders_day)
rm(user_avg_days_since_prior_order)
rm(user_avg_products_order)
```

Oliver:
nur erste Bestellungen schauen
- wie viele Artikel?
- Shares von aisles/departments (Produktkategorie)?
- 

```{r}
# Keeping only first orders
first_orders_products <- orders %>%
  filter(user_id %in% train_users,
         order_number == 1) %>%
  inner_join(order_products_prior, by = "order_id") %>%
  inner_join(products, by = "product_id") %>%
  dplyr::select(order_id,
                user_id,
                order_dow,
                order_hour_of_day,
                product_id,
                product_name,
                aisle_id,
                aisle,
                department_id,
                department,
                add_to_cart_order)

# How many products ordered?
user_product_count <- first_orders_products %>%
  group_by(user_id) %>%
  summarize(product_count = n())


# Shares for each department?
user_department_share <- first_orders_products %>%
  group_by(user_id, department) %>%
  summarize(count = n()) %>%
  spread(department, count) %>%
  replace(is.na(.), 0)

```

Oliver:
alle Bestellungen
- welche Artikel beliebter? -> kunden kauft mainstream artikel oder seltene artikel

```{r}
# All prior orders
prior_orders_products <- orders %>%
  filter(user_id %in% train_users) %>%
  inner_join(order_products_prior, by = "order_id") %>%
  inner_join(products, by = "product_id") %>%
  dplyr::select(order_id,
                user_id,
                order_number,
                order_dow,
                order_hour_of_day,
                days_since_prior_order,
                product_id,
                product_name,
                aisle_id,
                aisle,
                department_id,
                department,
                add_to_cart_order,
                reordered)


# Actually, is it possible to order the same product multiple times in an order?
prior_orders_products %>%
  group_by(order_id, product_id) %>%
  summarize(count = n()) %>%
  group_by(count) %>%
  summarize(product_per_order = n())
# Answer: NO!

# What are the most bought products?
products_ordered_amount <- prior_orders_products %>%
  group_by(product_id, product_name) %>%
  summarize(times_ordered = n()) %>%
  arrange(desc(times_ordered)) %>%
  ungroup() %>%
  mutate(share = times_ordered/sum(times_ordered)*100,
         product_category = ifelse(share <= quantile(share, probs = 0.25), "rare",
                            ifelse(share > quantile(share, probs = 0.25) & 
                                  share <= quantile(share, probs = 0.75), "normal",
                            "common")))


#  perzentile von share berechnet
  
  group_by(times_ordered) %>%
  mutate(times_distr = n()) %>%
  ungroup() %>%
  mutate(product_category = ifelse(times_distr == 1, "mainstream", "rare")) %>%
  arrange(desc(times_ordered))

# Look at the distribution of the times products were ordered
products_ordered_amount %>%
  group_by(times_ordered) %>%
  summarize(count = n()) %>%
  arrange(desc(count), desc(times_ordered)) %>%
  ggplot() +
  geom_line(aes(x = times_ordered, y = count), color = "red")

products_ordered_amount %>%
  group_by(times_ordered) %>%
  summarize(count = n()) %>%
  arrange(count, desc(times_ordered)) %>%
  filter(count == 1)

# What kind of products did the user buy in first order?
user_product_category <- first_orders_products %>%
  left_join(products_ordered_amount, by = c("product_id", "product_name")) %>%
  group_by(user_id, product_category) %>%
  summarize(count = n()) %>%
  spread(product_category, count) %>%
  replace(is.na(.), 0) %>%
  rename_at(vars(-user_id), function(x) tolower(paste0(x,"_product")))

user_product_category %>%
  ggplot() +
  geom_line(aes(x = mainstream, colour = "red"), stat="count", color = "red") +
  geom_line(aes(x = rare, colour = "yellow"), stat="count") +
  scale_color_discrete(name = "category_type", labels = c("mainstream", "rare")) +
  labs(x = "Products of each category type in the first order")
  


```

```{r}
# Join dataframes
users <- user_count_orders %>%
  full_join(user_product_count, by = "user_id") %>%
    full_join(user_product_category, by = "user_id") %>%
    full_join(user_department_share, by = "user_id")

orders_prior_no_test <- orders_no_test %>%
  right_join(order_products_prior_no_test, by = "order_id") %>%
  left_join(products, by = "product_id")
```

Silvia:
look if the behaviour displayed in the first order is repeated
```{r}
# # In first order
# user_product_count
# user_department_share
# user_product_category
# # Count of total orders
# user_count_orders
# 
# 
# 
# 
# for (k in users$user_id) {
#   for (i in 2:users$tot_orders) {
#   orders_prior_no_test %>%
#     filter(user_id == k,
#            order_number == i) %>%
#     dplyr::select(order_id)
#   order_products_prior_no_test %>%
#     filter(order_id == order) %>%
#     mutate(product_count_diff = count(product_id) - users$product_count)
#   
#   
#   }
# }
# 
# 
#   orders_prior_no_test %>%
#     left_join(users, by = "user_id") %>%
#     filter(user_id == 34,
#            order_number == 2) %>%
#     
#     summarize(product_count = n())
#     
#     group_by(user_id, department) %>%
#   summarize(count = n()) %>%
#   spread(department, count) %>%
#   replace(is.na(.), 0)
#   
#   group_by(user_id, product_category) %>%
#   summarize(count = n()) %>%
#   spread(product_category, count) %>%
#   replace(is.na(.), 0) %>%
#   rename_at(vars(-user_id), function(x) tolower(paste0(x,"_product")))
#   
#   
#     mutate(product_count_diff = count(product_id) - product_count)
```

Market basket analysis
```{r}
library(arules)
trObj<-as(orders_prior_no_test,"transactions")
```
