---
title: "Segmentation"
author: "Silvia Ventoruzzo"
date: "18/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Explanation of dataset:
- aisles and departments contain the respective id and name
- products contain the id, name and corresponsing aisle and department
- orders has one line pro order with the corresponding time, evaluation set and customer. "order_number" indicates the order for each customer in which the orders were placed
- order_products_(prior and train) contain more detailed information of the order, that is the products ordered, in which order they were put into the basket and if the corresponding customer already ordered that specific product 

```{r}
orders_prior <- orders %>%
  full_join(order_products_prior, by = "order_id") %>%
  arrange(user_id, order_number)
```

All 1st orders have NA for "days_since_prior_order" and 0 for all products in "reordered"
```{r}
orders_prior %>%
  filter(order_number == 1) %>%
  group_by(days_since_prior_order) %>%
  summarize(count = n())

orders_prior %>%
  filter(order_number == 1) %>%
  group_by(reordered) %>%
  summarize(count = n())
```

To which evaluation set do the orders for the different users belong?
```{r}
orders %>%
  group_by(user_id, eval_set) %>%
  summarize(count = n())
```

There is one department/aisle combination where both have value "missing". Since there is also one combination with "other", I will set this missing values so to say to the "other" category
```{r}
departments %>% filter(department == "missing" | department == "other")
# 2: other
# 21: missing

aisles %>% filter(aisle == "missing" | aisle == "other")
# 6: other
# 100: missing

# products
products <- products %>%
  left_join(aisles, by = "aisle_id") %>%
  left_join(departments, by = "department_id") %>%
  mutate(department_id = replace(department_id, department == "missing", 2),
         department = replace(department, department == "missing", "other"),
         aisle_id = replace(aisle_id, aisle == "missing", 6),
         aisle = replace(aisle, aisle == "missing", "other"))

# departments
departments <- departments %>%
  mutate(department_id = replace(department_id, department == "missing", 2),
         department = fct_recode(department, "other" = "missing")) %>%
  distinct(department_id, department)
         
# aisles
aisles <- aisles %>%
  mutate(aisle_id = replace(aisle_id, aisle == "missing", 6),
         aisle = fct_recode(aisle, "other" = "missing")) %>%
  distinct(aisle_id, aisle)

```

Each aisles is assigned to one specific department
```{r}
products %>%
  group_by(aisle_id) %>%
  summarize(count_department_id = n_distinct(department_id)) %>%
  summarize(aisle_department = sum(count_department_id))

aisles_departments <- products %>%
  distinct(department_id, aisle_id) %>%
  left_join(aisles, by = "aisle_id") %>%
  left_join(departments, by = "department_id") %>%
  arrange(department_id) 
```

Treemap aisles/department
```{r}
library(treemap)
products %>%
  group_by(department, aisle) %>%
  summarize(count = n()) %>%
  treemap(dtf = .,
          index = c("department", "aisle"),
          vSize = "count",
          type = "index",
          palette = "Spectral",
          title = "Products per department and aisle")

products %>%
  group_by(department) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

products %>%
  group_by(aisle) %>%
  summarize(count = n()) %>%
  arrange(desc(count))

```

What info can we get about customers?
- how many orders they did?
- how often they ordered?
- how many products pro order?
```{r}
# Keep only customers where we have complete information about orders (prior + train)
train_users <- orders %>%
  filter(eval_set == "train") %>% 
  distinct(user_id) %>%
  pull()
orders_train_users <- orders %>%
  filter(user_id %in% train_users) %>%
  distinct(order_id) %>%
  pull()
orders_no_test <- orders %>%
  filter(user_id %in% train_users) %>%
  droplevels()
order_products_prior_no_test <- order_products_prior %>%
  filter(order_id %in% orders_train_users) %>%
  droplevels()

# How many orders they did?
user_count_orders <- orders_no_test %>%
  group_by(user_id) %>%
  summarize(count_orders = n_distinct(order_id))

user_orders_day <- orders_no_test %>%
  group_by(user_id, order_dow) %>%
  summarize(count = n()) %>%
  spread(order_dow, count) %>%
  replace(is.na(.), 0) %>%
  rename_at(vars(-user_id), function(x) paste0(x,"_orders"))
user_orders_day

library(stringr)


# How often they ordered?
user_avg_days_since_prior_order <- orders_no_test %>%
  filter(order_number != 1) %>%
  group_by(user_id) %>%
  summarize(avg_days_since_prior_order = round(sum(days_since_prior_order)/n(), 0))

# How many products per order?
user_avg_products_order <- order_products_prior_no_test %>%
  full_join(order_products_train, by = c("order_id", "product_id", "add_to_cart_order", "reordered")) %>%
  right_join(orders_no_test, by = "order_id") %>%
  group_by(user_id) %>%
  summarize(avg_products_order = round(n()/n_distinct(order_id), 0))




```