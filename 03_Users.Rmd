---
title: "Segmentation"
author: "Silvia Ventoruzzo"
date: "18/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Explanation of dataset:
- aisles and departments contain the respective id and name
- products contain the id, name and corresponsing aisle and department
- orders has one line pro order with the corresponding time, evaluation set and customer. "order_number" indicates the order for each customer in which the orders were placed
- order_products_(prior and train) contain more detailed information of the order, that is the products ordered, in which order they were put into the basket and if the corresponding customer already ordered that specific product 

# Keep only prior orders of customers where we have complete information about orders (prior + train)

```{r}
# Find "train"-customers
train_users <- orders %>%
  filter(eval_set == "train") %>% 
  distinct(user_id) %>%
  pull()

# Keep only prior orders from those customers
train_orders_prior <- orders %>%
  filter(user_id %in% train_users) %>%
  inner_join(order_products_prior, by = "order_id") %>%
  inner_join(products, by = "product_id") %>%
  arrange(user_id, order_number) %>%
  droplevels()

# Create dataframe with only first order of each customer
train_order_first <- train_orders_prior %>%
  filter(order_number == 1)

# All 1st orders have NA for "days_since_prior_order" and 0 for all products in "reordered"

orders_prior %>%
  filter(order_number == 1) %>%
  group_by(days_since_prior_order) %>%
  summarize(count = n())

orders_prior %>%
  filter(order_number == 1) %>%
  group_by(reordered) %>%
  summarize(count = n())

train_order_first <- train_order_first %>%
  select(-days_since_prior_order, -reordered)

rm("orders", "order_products_prior", "products", "train_users")
```

Oliver:
nur erste Bestellungen schauen
- wie viele Artikel?
- Shares von aisles/departments (Produktkategorie)?
- 

```{r}
# How many products ordered?
user_product_count <- orders_first %>%
  group_by(user_id) %>%
  summarize(product_count = n()) %>%
  ungroup()

# Shares for each aisle?
user_aisle_share <- orders_first %>%
  group_by(user_id, aisle) %>%
  summarize(count = n()) %>%
  ungroup() %>%
  spread(aisle, count) %>%
  replace(is.na(.), 0)
```

Oliver:
alle Bestellungen
- welche Artikel beliebter? -> kunden kauft mainstream artikel oder seltene artikel

```{r}

# Actually, is it possible to order the same product multiple times in an order?
orders_prior %>%
  group_by(order_id, product_id) %>%
  summarize(count = n()) %>%
  group_by(count) %>%
  summarize(product_per_order = n())
# Answer: NO!

# What are the most bought products?
products_ordered_amount <- orders_prior %>%
  group_by(product_id, product_name) %>%
  summarize(times_ordered = n()) %>%
  arrange(desc(times_ordered)) %>%
  ungroup() %>%
  mutate(share = times_ordered/sum(times_ordered)*100,
         product_category = ifelse(share <= quantile(share, probs = 0.25), "rare",
                            ifelse(share > quantile(share, probs = 0.25) & 
                                  share <= quantile(share, probs = 0.75), "normal",
                            "common")))

# Look at the distribution of the times products were ordered
products_ordered_amount %>%
  group_by(times_ordered) %>%
  summarize(count = n()) %>%
  arrange(desc(count), desc(times_ordered)) %>%
  ggplot() +
  geom_line(aes(x = times_ordered, y = count), color = "red")

products_ordered_amount %>%
  group_by(times_ordered) %>%
  summarize(count = n()) %>%
  arrange(count, desc(times_ordered)) %>%
  filter(count == 1)

# What kind of products did the user buy in first order?
user_product_category <- orders_first %>%
  left_join(products_ordered_amount, by = c("product_id", "product_name")) %>%
  group_by(user_id, product_category) %>%
  summarize(count = n()) %>%
  spread(product_category, count) %>%
  replace(is.na(.), 0) %>%
  rename_at(vars(-user_id), function(x) tolower(paste0(x,"_product")))

user_product_category %>%
  ggplot() +
  geom_line(aes(x = common_product, colour = "red"), stat="count") +
  geom_line(aes(x = normal_product, colour = "orange"), stat="count") +
  geom_line(aes(x = rare_product, colour = "yellow"), stat="count") +
  scale_color_discrete(name = "product_category", labels = c("common", "normal", "rare")) +
  labs(x = "Products of each category type in the first order")
  
```

```{r}
# Join dataframes
users <- user_count_orders %>%
  full_join(user_product_count, by = "user_id") %>%
  full_join(user_product_category, by = "user_id") %>%
  full_join(user_aisle_share, by = "user_id") %>%
  mutate(user_id = as.factor(user_id))

rm("orders_prior", "orders_first", "products_ordered_amount", "user_count_orders",
   "user_department_share", "user_product_category", "user_product_count")
```





What info can we get about customers?
- how many orders they did?
- how many orders per day?
- how often they ordered?
- how many products pro order?

MAYBE I SHOULD DO ALL OF THIS ONLY ON PRIOR SET FOR TRAIN USERS
```{r}


# How many orders they did?
user_count_orders <- orders_prior %>%
  group_by(user_id) %>%
  summarize(tot_orders = n_distinct(order_id))

# How many orders per day?
# user_orders_day <- orders_no_test %>%
#   group_by(user_id, order_dow) %>%
#   summarize(count = n()) %>%
#   spread(order_dow, count) %>%
#   replace(is.na(.), 0) %>%
#   rename_at(vars(-user_id), function(x) tolower(paste0(x,"_orders")))

# How often they ordered?
# user_avg_days_since_prior_order <- orders_no_test %>%
#   filter(order_number != 1) %>%
#   group_by(user_id) %>%
#   summarize(avg_days_since_prior_order = round(sum(days_since_prior_order)/n(), 0))

# How many products per order?
# user_avg_products_order <- order_products_prior_no_test %>%
#   full_join(order_products_train, by = c("order_id", "product_id", "add_to_cart_order", "reordered")) %>%
#   right_join(orders_no_test, by = "order_id") %>%
#   group_by(user_id) %>%
#   summarize(avg_products_order = round(n()/n_distinct(order_id), 0))

# Join dataframes
# users <- user_count_orders %>%
#   inner_join(user_orders_day, by = "user_id") %>%
#   inner_join(user_avg_days_since_prior_order, by = "user_id") %>%
#   inner_join(user_avg_products_order, by = "user_id")
# rm(user_count_orders)
# rm(user_orders_day)
# rm(user_avg_days_since_prior_order)
# rm(user_avg_products_order)
```



Silvia:
look if the behaviour displayed in the first order is repeated
```{r}
# # In first order
# user_product_count
# user_department_share
# user_product_category
# # Count of total orders
# user_count_orders
# 
# 
# 
# 
# for (k in users$user_id) {
#   for (i in 2:users$tot_orders) {
#   orders_prior_no_test %>%
#     filter(user_id == k,
#            order_number == i) %>%
#     dplyr::select(order_id)
#   order_products_prior_no_test %>%
#     filter(order_id == order) %>%
#     mutate(product_count_diff = count(product_id) - users$product_count)
#   
#   
#   }
# }
# 
# 
#   orders_prior_no_test %>%
#     left_join(users, by = "user_id") %>%
#     filter(user_id == 34,
#            order_number == 2) %>%
#     
#     summarize(product_count = n())
#     
#     group_by(user_id, department) %>%
#   summarize(count = n()) %>%
#   spread(department, count) %>%
#   replace(is.na(.), 0)
#   
#   group_by(user_id, product_category) %>%
#   summarize(count = n()) %>%
#   spread(product_category, count) %>%
#   replace(is.na(.), 0) %>%
#   rename_at(vars(-user_id), function(x) tolower(paste0(x,"_product")))
#   
#   
#     mutate(product_count_diff = count(product_id) - product_count)
```

Market basket analysis
```{r}
# library(arules)
# trObj<-as(orders_prior_no_test,"transactions")
```
